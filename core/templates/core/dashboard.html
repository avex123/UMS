{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="fw-bold mb-3">Welcome to UMS ERP</h2>
    <p class="text-muted mb-4">Your centralized dashboard for managing projects, customers, inventory, and tasks.</p>

    <!-- ðŸ”¥ Main Dashboard Cards -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <!-- Projects -->
        <div class="col">
            <div class="card shadow-sm border-0" style="border-top: 4px solid #dc3545; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title fw-semibold">Projects</h5>
                    <p class="card-text text-muted small">Manage all active and archived projects efficiently.</p>
                    <a href="{% url 'project_list' %}" class="btn btn-danger btn-sm w-100">
                        View Projects
                    </a>
                </div>
            </div>
        </div>

        <!-- Customers -->
        <div class="col">
            <div class="card shadow-sm border-0" style="border-top: 4px solid #dc3545; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title fw-semibold">Customers</h5>
                    <p class="card-text text-muted small">View and manage all customer information.</p>
                    <a href="{% url 'customer_list' %}" class="btn btn-danger btn-sm w-100">
                        View Customers
                    </a>
                </div>
            </div>
        </div>

        <!-- Inventory -->
        <div class="col">
            <div class="card shadow-sm border-0" style="border-top: 4px solid #dc3545; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title fw-semibold">Inventory</h5>
                    <p class="card-text text-muted small">Keep track of materials and parts in real-time.</p>
                    <a href="{% url 'inventory_list' %}" class="btn btn-danger btn-sm w-100">
                        View Inventory
                    </a>
                </div>
            </div>
        </div>

        <!-- Tasks -->
        <div class="col">
            <div class="card shadow-sm border-0" style="border-top: 4px solid #dc3545; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title fw-semibold">Tasks</h5>
                    <p class="card-text text-muted small">Assign and monitor tasks for your team effectively.</p>
                    <a href="{% url 'task_dashboard' %}" class="btn btn-danger btn-sm w-100">
                        View Tasks
                    </a>
                </div>
            </div>
        </div>

        <!-- Cutting Lists -->
        <div class="col">
            <div class="card shadow-sm border-0" style="border-top: 4px solid #dc3545; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title fw-semibold">Cutting Lists</h5>
                    <p class="card-text text-muted small">Create and manage cutting lists with material usage tracking.</p>
                    <a href="{% url 'cutting_list_dashboard' %}" class="btn btn-danger btn-sm w-100">
                        View Cutting Lists
                    </a>
                </div>
            </div>
        </div>

        <!-- Quotes -->
        <div class="col">
            <div class="card shadow-sm border-0" style="border-top: 4px solid #dc3545; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title fw-semibold">Quotes</h5>
                    <p class="card-text text-muted small">Create, manage, and send detailed quotes to customers.</p>
                    <a href="{% url 'quote_dashboard' %}" class="btn btn-danger btn-sm w-100">
                        View Quotes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ðŸ“Š Combined Insights + KPI Highlights -->
    <div class="card shadow-sm border-0 mt-4" style="border-top: 4px solid #343a40; border-radius: 12px;">
        <div class="card-body py-3">
            <h5 class="card-title fw-bold mb-3" style="color: #000;">Dashboard Insights</h5>
            <div class="row row-cols-2 row-cols-md-4 g-3">
                <div class="col">
                    <div class="border rounded p-2 text-center">
                        <h6 class="fw-bold mb-1 text-danger">Projects</h6>
                        <p class="mb-0">{{ total_projects }}</p>
                    </div>
                </div>
                <div class="col">
                    <div class="border rounded p-2 text-center">
                        <h6 class="fw-bold mb-1 text-danger">Active Tasks</h6>
                        <p class="mb-0">{{ active_tasks }}</p>
                    </div>
                </div>
                <div class="col">
                    <div class="border rounded p-2 text-center">
                        <h6 class="fw-bold mb-1 text-danger">Inventory Items</h6>
                        <p class="mb-0">{{ total_inventory_items }}</p>
                    </div>
                </div>
                <div class="col">
                    <div class="border rounded p-2 text-center">
                        <h6 class="fw-bold mb-1 text-danger">Pending Quotes</h6>
                        <p class="mb-0">{{ pending_quotes }}</p>
                    </div>
                </div>
                <div class="col">
                    <div class="border rounded p-2 text-center">
                        <h6 class="fw-bold mb-1 text-danger">Overdue Tasks</h6>
                        <p class="mb-0">{{ overdue_tasks }}</p>
                    </div>
                </div>
                <div class="col">
                    <div class="border rounded p-2 text-center">
                        <h6 class="fw-bold mb-1 text-danger">Low Stock Items</h6>
                        <p class="mb-0">{{ low_stock_items }}</p>
                    </div>
                </div>
                <div class="col">
                    <div class="border rounded p-2 text-center">
                        <h6 class="fw-bold mb-1 text-danger">Projects In Progress</h6>
                        <p class="mb-0">{{ projects_in_progress }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- âš¡ Quick Actions -->
    <div class="card shadow-sm border-0 mt-4" style="border-top: 4px solid #dc3545; border-radius: 12px;">
        <div class="card-body">
            <h5 class="card-title fw-bold mb-3" style="color: #dc3545;">Quick Actions</h5>
            <div class="d-flex flex-wrap gap-2">
                <a href="{% url 'project_create' %}" class="btn btn-outline-danger btn-sm">âž• New Project</a>
                <a href="{% url 'task_create' %}" class="btn btn-outline-danger btn-sm">âž• New Task</a>
                <a href="{% url 'quote_create' %}" class="btn btn-outline-danger btn-sm">âž• New Quote</a>
                <a href="{% url 'cutting_list_create' %}" class="btn btn-outline-danger btn-sm">âž• New Cutting List</a>
                <a href="{% url 'shipment_create' %}" class="btn btn-outline-danger btn-sm">âž• New Shippment</a>
            </div>
        </div>
    </div>
    <style>
        .fc .fc-toolbar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #000;
        }
        .fc-button-primary {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }
        .fc-button-primary:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .fc-button-primary:focus {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.5);
        }
        .fc-daygrid-event {
            background-color: #dc3545 !important;
            border: none;
            color: #fff;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.85rem;
        }
        .fc-daygrid-day-number {
            color: #000;
            font-weight: 500;
        }
        .fc-daygrid-event:hover {
            background-color: #bd2130 !important;
        }
</style>
<!-- ðŸ“… Dashboard Calendar -->
<div class="card shadow-sm border-0 mt-4" style="border-top: 4px solid #0d6efd; border-radius: 12px;">
    <div class="card-body">
        <h5 class="card-title fw-bold mb-3" style="color: #0d6efd;">ðŸ“… Calendar</h5>
        <div id="dashboard-calendar"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('dashboard-calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            themeSystem: 'bootstrap5',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            height: 'auto',
            events: '/calendar/events/',  // Load all events: tasks, projects, quotes, reminders

            dateClick: function(info) {
                const title = prompt("Enter reminder title:");
                if (title) {
                    fetch('/calendar/add_reminder/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: title,
                            date: info.dateStr
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            calendar.refetchEvents();
                        } else {
                            alert('Failed to add reminder.');
                        }
                    });
                }
            },

            eventClick: function(info) {
                // Check if it's a reminder
                if (info.event.id.startsWith('reminder-')) {
                    const reminderId = info.event.id.split('-')[1];
                    const action = prompt(
                        `Edit title for reminder or type DELETE to remove it:`,
                        info.event.title.replace('ðŸ”” ', '')
                    );

                    if (action === null) {
                        // Do nothing
                        return;
                    } else if (action.toUpperCase() === "DELETE") {
                        fetch(`/calendar/delete_reminder/${reminderId}/`, {
                            method: 'POST',
                            headers: {'X-CSRFToken': '{{ csrf_token }}'}
                        })
                        .then(() => calendar.refetchEvents());
                    } else {
                        fetch(`/calendar/edit_reminder/${reminderId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: action
                            })
                        })
                        .then(() => calendar.refetchEvents());
                    }

                    info.jsEvent.preventDefault();
                }
                else if (info.event.url) {
                    // Open tasks/projects/quotes in new tab
                    window.open(info.event.url, "_blank");
                    info.jsEvent.preventDefault();
                }
            }
        });

        calendar.render();
    });
</script>

<style>
    .fc {
        font-family: 'Roboto', sans-serif;
    }
    .fc-toolbar-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #343a40;
    }
    .fc-button-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }
    .fc-daygrid-event {
        border-radius: 8px;
        padding: 3px 6px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}
